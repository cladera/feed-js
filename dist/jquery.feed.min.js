/*! jquery.feed 2015-04-17 */
!function(a){var b=function(a,b){this.context=b,this.options=a,this.running=!1,this.lastCommentId=0,this.lastAnswerId=0,this.comments={},this.answers={},this.orphanAnswers={},this.commentsEndpoint=this.options.commentsEndpoint||"http://localhost:3000/questions",this.answersEndpoint=this.options.answersEndpoint||"http://localhost:3000/answers",this.context.addClass("feed"),this.options.auto&&this.options.refreshDelay>0&&(this.running=!0,this._getComments())};b.prototype._renderMessage=function(b,c,d,e){e=e||"comment";var f=a('<div class="'+e+'"></div>');return f.append('<div class="author"><span class="name">'+b+"</span></div>"),f.append('<div class="datetime">'+this.options.renderDate.call(this,d)+"</div>"),f.append('<div class="body">'+c||"</div>"),f},b.prototype.addComment=function(a){if(!this.comments.hasOwnProperty(a.id)){var b=this._renderMessage(a.author.name,a.body,a.datetime);return b.append('<div class="answers"></div>'),b.hide(),this.context.prepend(b),b.fadeIn("slow"),a.context=b,a.answers={},this.comments[a.id]=a,a.id>this.lastCommentId&&(this.lastCommentId=a.id),this}},b.prototype.addAnswer=function(a){var b=this.comments[a.question_id];if(b){var c=this,d=b.context.find(".answers");a.context=c._renderMessage(a.moderatorName,a.body,a.createdAt,"comment answer"),b.context.fadeOut(function(){d.append(a.context),c.context.prepend(b.context),b.context.fadeIn("slow")}),b.answers[a.id]=a,a.id>this.lastAnswerId&&(this.lastAnswerId=a.id)}},b.prototype.refreshDates=function(){var b=this;a.each(b.comments,function(c,d){d.context.children(".datetime").html(b.options.renderDate.call(b,d.datetime)),a.each(d.answers,function(a,c){c.context.children(".datetime").html(b.options.renderDate.call(b,c.createdAt))})})},b.prototype.refresh=function(){this._getComments()},b.prototype.stop=function(){this.running=!1},b.prototype.start=function(){this.running!==!0&&(this.running=!0,this._getComments())},b.prototype._getComments=function(){if(!this.commentsEndpoint)throw new Error("Invalid comments endpoint");var b=this;a.ajax({url:b.commentsEndpoint,dataType:"json",data:b.options.idFilter+"="+b.lastCommentId}).done(function(c){c.length>0&&a.each(c,function(a,c){c.author.name&&""!==c.author.name&&" "!==c.author.name||(c.author.name=c.author.email.split("@")[0]),b.addComment(c)}),b.refreshDates(),b._getAnswers()}).error(function(){b.context.trigger("error"),!b.options.haltOnError&&b.running&&b.options.refreshDelay>0&&setTimeout(function(){b.running&&b._getComments()},1e3*b.options.refreshDelay)})},b.prototype._getAnswers=function(){if(!this.answersEndpoint)throw new Error("Invalid answers endpoint");var b=this;a.ajax({url:b.answersEndpoint,dataType:"json",data:b.options.idFilter+"="+b.lastAnswerId}).done(function(c){c.length>0&&a.each(c,function(a,c){"string"==typeof c.id&&(c.id=parseInt(c.id,10)),c.moderatorName&&""!==c.moderatorName&&" "!==c.moderatorName||(c.moderatorName=c.moderatorEmail.split("@")[0]),b.addAnswer(c)}),b.refreshDates(),b.running&&b.options.refreshDelay>0&&setTimeout(function(){b.running&&b._getComments()},1e3*b.options.refreshDelay)}).error(function(){b.context.trigger("error"),!b.options.haltOnError&&b.running&&b.options.refreshDelay>0&&setTimeout(function(){b.running&&b._getComments()},1e3*b.options.refreshDelay)})},a.widget("ui.feed",{options:{renderDate:function(a){return a},auto:!1,refreshDelay:0,source:[],idFilter:"since",haltOnError:!0},_create:function(){this.feed=new b(this.options,this.element)},destroy:function(){},_setOption:function(a){},add:function(a){this.feed.add(a)},refresh:function(){this.feed.refresh()},start:function(){this.feed.start()},stop:function(){this.feed.stop()}})}(jQuery);